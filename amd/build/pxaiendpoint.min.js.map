{"version":3,"file":"pxaiendpoint.min.js","sources":["../src/pxaiendpoint.js"],"sourcesContent":["import $ from \"jquery\";\nimport Ajax from \"core/ajax\";\nimport AISubmissionEvent from \"./app/ai/event\";\nimport AISubmissionPageChangeEvent from \"./app/ai/page_change_event\";\n\n/**\n * @param {number} id\n * @param {number} cmid\n * @param {number} contextid\n * @param {string} steps_data\n * @param {number} assignmentid\n * @param {string} attempt_text\n */\nexport const init = (\n    id,\n    cmid,\n    contextid,\n    steps_data,\n    assignmentid,\n    attempt_text\n) => {\n\n    let EventCreator = function (stepsData, assignmentId, attemptText) {\n        this.currStep = 0;\n        this.selStart = 0;\n        this.selEnd = 0;\n        this.assignmentid = assignmentId;\n        this.attempt_text = attemptText;\n        this.init();\n    };\n\n    EventCreator.prototype.init = function () {\n\n        this.setAttemtCountText(this.attempt_text);\n        const container = $(\".actions-container\");\n\n        /**\n         * @param {HTMLElement} button\n         */\n        const highlightStepButton = (button) => {\n            if (!(button instanceof HTMLElement)) {\n                return;\n            }\n            button.classList.add('btn-outline-primary');\n            button.classList.remove('btn-outline-secondary');\n        };\n\n        /**\n         * @param {HTMLElement} button\n         */\n        const blurStepButton = (button) => {\n            if (!(button instanceof HTMLElement)) {\n                return;\n            }\n            button.classList.remove('btn-outline-primary');\n            button.classList.add('btn-outline-secondary');\n        };\n\n        let getSelectedTextareaText = function (name) {\n\n            let selText = '';\n            let textArea = document.getElementsByName(name);\n            textArea = (textArea && textArea.length > 0) ? textArea[0] : null;\n            if (textArea) {\n                let start = textArea.selectionStart;\n                this.selStart = start;\n                let finish = textArea.selectionEnd;\n                this.selEnd = finish;\n                selText = textArea.value.substring(start, finish);\n            } else {\n                window.console.log(\"pxaiwriter : no known text selecable source\");\n            }\n            return selText;\n\n        }.bind(this);\n\n        document.querySelector('.assignsubmission_pxaiwriter').addEventListener(AISubmissionEvent.EventList.pageChange, (e) => {\n\n            const event = new AISubmissionPageChangeEvent(e);\n            const currentStepSelector = `.step-page-button[data-step-number=\"${event.currentStep}\"]`;\n            const allStepSelector = `.step-page-button[data-step-number]`;\n            const currentStepButton = document.querySelector(currentStepSelector);\n            if (!currentStepButton) {\n                return;\n            }\n\n            const allStepButtons = document.querySelectorAll(allStepSelector);\n            for (const button of allStepButtons) {\n                blurStepButton(button);\n            }\n            highlightStepButton(currentStepButton);\n        });\n\n        container.on(\"click\", '#pxaiwriter-expand-selection', function (e) {\n\n            const currentStep = $(e.target).data(\"step\");\n            this.currStep = currentStep;\n            const selectedText = getSelectedTextareaText(\"pxaiwriter-data-step-\" + currentStep);\n\n            if (!selectedText) {\n                $('#text-selection-required-warning-modal').modal('show');\n                return;\n            }\n\n            $(':button').prop('disabled', true);\n            $('#loader').removeClass('d-none');\n\n            Ajax.call([\n                {\n                    methodname: \"assignsubmission_pxaiwriter_expand_ai_text\",\n                    args: {\n                        assignment_id: this.assignmentid,\n                        step: this.currStep,\n                        text: selectedText\n                    },\n                    done: this.handleExpandResponse.bind(this),\n                    fail: this.handleExpandFailure.bind(this),\n                },\n            ]);\n\n        }.bind(this));\n\n        container.on(\"click\", '#pxaiwriter-do-ai-magic', function (e) {\n\n            const currentStep = $(e.target).data(\"step\");\n            this.currStep = currentStep;\n            const titleText = $('[name=\"pxaiwriter-data-step-' + currentStep + '\"]').val();\n\n            if (!titleText) {\n                $('#title-required-warning-modal').modal('show');\n                return;\n            }\n\n            $(':button').prop('disabled', true);\n            $('#loader').removeClass('d-none');\n\n            Ajax.call([\n                {\n                    methodname: \"assignsubmission_pxaiwriter_generate_ai_text\",\n                    args: {\n                        assignment_id: this.assignmentid ?? 2,\n                        step: this.currStep,\n                        text: titleText\n                    },\n                    done: this.handleAiMagicResponse.bind(this),\n                    fail: this.handleAiMagicFailure.bind(this),\n                },\n            ]);\n\n        }.bind(this));\n    };\n\n    EventCreator.prototype.handleAiMagicResponse = function (response) {\n        $(':button').prop('disabled', false);\n        if (response.hasOwnProperty('data')) {\n            this.setAttemtCountText(response.attempt_text);\n            const textArea = $('textarea[name=\"pxaiwriter-data-step-' + this.currStep + '\"]');\n            textArea.val(response.data);\n            textArea.trigger(\"change\");\n        }\n        $('#loader').addClass('d-none');\n    };\n\n    EventCreator.prototype.handleAiMagicFailure = function (response) {\n        $(':button').prop('disabled', false);\n        window.console.error(response);\n        $('#loader').addClass('d-none');\n    };\n\n    EventCreator.prototype.handleExpandResponse = function (response) {\n        $(':button').prop('disabled', false);\n        if (response.hasOwnProperty('data')) {\n            this.setAttemtCountText(response.attempt_text);\n            const textArea = $('textarea[name=\"pxaiwriter-data-step-' + this.currStep + '\"]');\n            textArea.val(response.data);\n            textArea.trigger(\"change\");\n        }\n        $('#loader').addClass('d-none');\n    };\n\n    EventCreator.prototype.handleExpandFailure = function (error) {\n        $(':button').prop('disabled', false);\n        let responseObj = JSON.parse(error);\n        alert(responseObj.message ?? '');\n        $('#loader').addClass('d-none');\n    };\n\n    EventCreator.prototype.setAttemtCountText = function (text) {\n        if (text) {\n            $(\".remaining-ai-attempts\").text(text);\n        }\n    };\n\n    return new EventCreator(steps_data, assignmentid, attempt_text);\n};\n"],"names":["id","cmid","contextid","steps_data","assignmentid","attempt_text","EventCreator","stepsData","assignmentId","attemptText","currStep","selStart","selEnd","init","prototype","setAttemtCountText","this","container","blurStepButton","button","HTMLElement","classList","remove","add","getSelectedTextareaText","name","selText","textArea","document","getElementsByName","length","start","selectionStart","finish","selectionEnd","value","substring","window","console","log","bind","querySelector","addEventListener","AISubmissionEvent","EventList","pageChange","e","event","AISubmissionPageChangeEvent","currentStepSelector","currentStep","currentStepButton","allStepButtons","querySelectorAll","on","target","data","selectedText","prop","removeClass","call","methodname","args","assignment_id","step","text","done","handleExpandResponse","fail","handleExpandFailure","modal","titleText","val","handleAiMagicResponse","handleAiMagicFailure","response","hasOwnProperty","trigger","addClass","error","responseObj","JSON","parse","alert","message"],"mappings":"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"}