{"version":3,"file":"pxaiendpoint.min.js","sources":["../src/pxaiendpoint.js"],"sourcesContent":["import $ from \"jquery\";\nimport Ajax from \"core/ajax\";\nimport Notification from \"core/notification\";\n\n/**\n * @typedef TextAreaData\n * @property {string} text\n * @property {string} selectedText\n * @property {number} selectionStart\n * @property {number} selectionEnd\n */\n\n/**\n * @param {number} assignmentId\n */\nexport const init = (\n    assignmentId\n) => {\n\n    const defaultStep = 1;\n\n    let EventCreator = function (assignmentId, submissionId) {\n        this.currentStep = defaultStep;\n        this.selectedStart = 0;\n        this.selectedEnd = 0;\n        this.assignmentId = assignmentId;\n        this.submissionId = submissionId;\n        this.init();\n    };\n\n    const component = 'assignsubmission_pxaiwriter';\n\n    const eventList = {\n        pageChange: 'page-change',\n        stepTextSave: 'step-save'\n    };\n\n    const selectors = {\n        wrapper: '.assignsubmission_pxaiwriter',\n        doAIMagic: '#pxaiwriter-do-ai-magic',\n        expandSelection: '#pxaiwriter-expand-selection'\n    };\n\n    /**\n     * @return {boolean}\n     */\n    const isDebugMode = () => {\n        return !!M?.cfg?.developerdebug;\n    };\n\n    /**\n     * @param {string} text\n     */\n    const setRemainingAttemptText = (text) => {\n        if (!text) {\n            return;\n        }\n        const label = document.querySelector('.remaining-ai-attempts');\n        if (label instanceof HTMLElement) {\n            label.innerHTML = text;\n        }\n    };\n\n    /**\n     * @param {number} step\n     * @return {HTMLTextAreaElement|null}\n     */\n    const getStepTextArea = (step) => {\n        return document.querySelector(`textarea[name=\"pxaiwriter-data-step-${step}\"]`);\n    };\n\n    /**\n     * @param {HTMLElement} element\n     * @return {number}\n     */\n    const getCurrentStep = (element) => {\n        const currentStep = Number.parseInt(element?.dataset?.step);\n        if (Number.isNaN(currentStep)) {\n            return 0;\n        }\n        return currentStep;\n    };\n\n    /**\n     * @param {number} step\n     * @return {TextAreaData|null}\n     */\n    const getStepTextAreaData = (step) => {\n        const textArea = getStepTextArea(step);\n        if (!(textArea instanceof HTMLTextAreaElement)) {\n            return null;\n        }\n        return {\n            text: textArea.value,\n            selectedText: textArea.value.substring(textArea.selectionStart, textArea.selectionEnd),\n            selectionStart: textArea.selectionStart,\n            selectionEnd: textArea.selectionEnd\n        };\n    };\n\n    /**\n     * @param {number} step\n     * @return {string}\n     */\n    const getStepInputText = (step) => {\n        return getStepTextArea(step)?.value ?? '';\n    };\n\n    /**\n     * @param {string} text\n     * @return {boolean}\n     */\n    const validateInputText = (text) => {\n        if (!text || text.length === 0) {\n            $('#title-required-warning-modal').modal('show');\n            return false;\n        }\n        return true;\n    };\n\n    const loadingData = () => {\n        $(':button').prop('disabled', true);\n        $('#loader').removeClass('d-none');\n    };\n\n    /**\n     * @param {CustomEvent|Event} event\n     * @return {number}\n     */\n    const getCurrentStepByPageChangeEvent = (event) => {\n        return event?.detail?.currentStep;\n    };\n\n    /**\n     *\n     * @param {CustomEvent|Event} event\n     * @return {number}\n     */\n    const getPreviousStepByPageChangeEvent = (event) => {\n        const currentStep = getCurrentStepByPageChangeEvent(event);\n        const prevStep = event?.detail?.prevStep;\n        return currentStep === prevStep ? 0 : prevStep;\n    };\n\n    /**\n     * @param {string} text\n     * @return {Promise<string|null>}\n     */\n    const getHashCode = async (text) => {\n        if (!text) {\n            return null;\n        }\n        try {\n            const encoder = new TextEncoder();\n            const buffer = encoder.encode(text);\n            const raw = await crypto.subtle.digest(\"SHA-256\", buffer);\n            return Array.from(new Uint8Array(raw)).map(b => b.toString(16).padStart(2, \"0\")).join(\"\");\n        }\n        catch (e) {}\n        return null;\n    };\n\n    /**\n     * @template T\n     * @param {string} methodName\n     * @param {*} parameters\n     * @return {Promise<T>}\n     */\n    const requestAIApi = (methodName, parameters = {}) => {\n        return Ajax.call([\n            {\n                methodname: methodName,\n                args: parameters\n            },\n        ])[0];\n    };\n\n    const api = {\n        /**\n         * @template T\n         * @param {number} assignmentId\n         * @param {number} submissionId\n         * @param {string} text\n         * @param {string} selectedText\n         * @param {number} selectStart\n         * @return {Promise<T>}\n         */\n        expandText: (assignmentId, submissionId, text, selectedText, selectStart) => {\n            return requestAIApi(\n                'assignsubmission_pxaiwriter_expand_ai_text', {\n                assignment_id: assignmentId,\n                submission: submissionId,\n                text: text,\n                selected_text: selectedText,\n                select_start: selectStart,\n                step: defaultStep\n            });\n        },\n        /**\n         * @template T\n         * @param {number} assignmentId\n         * @param {number} submissionId\n         * @param {string} text\n         * @return {Promise<T>}\n         */\n        generateText: (assignmentId, submissionId, text) => {\n            return requestAIApi('assignsubmission_pxaiwriter_generate_ai_text', {\n                assignment_id: assignmentId,\n                submission: submissionId,\n                text: text,\n                step: defaultStep\n            });\n        },\n        /**\n         * @template T\n         * @param {number} assignmentId\n         * @param {number} submissionId\n         * @param {string} text\n         * @param {number} step\n         * @return {Promise<T>}\n         */\n        recordHistory: (assignmentId, submissionId, text, step = 1) => {\n            return requestAIApi('assignsubmission_pxaiwriter_record_history', {\n                assignment_id: assignmentId,\n                submission: submissionId,\n                text: text,\n                step: step\n            });\n        }\n    };\n\n    EventCreator.prototype.init = function () {\n        /**\n         * @param {HTMLElement} button\n         */\n        const highlightStepButton = (button) => {\n\n            if (!(button instanceof HTMLElement)) {\n                return;\n            }\n\n            button.classList.add('btn-outline-primary');\n            button.classList.remove('btn-outline-secondary');\n        };\n\n        /**\n         * @param {HTMLElement} button\n         */\n        const blurStepButton = (button) => {\n\n            if (!(button instanceof HTMLElement)) {\n                return;\n            }\n\n            button.classList.remove('btn-outline-primary');\n            button.classList.add('btn-outline-secondary');\n        };\n\n        const wrapper = document.querySelector(selectors.wrapper);\n\n        wrapper?.addEventListener(eventList.pageChange, (e) => {\n\n            if (isDebugMode()) {\n                window.console.log(`${component}: Step switched...`);\n            }\n\n            let step = getCurrentStepByPageChangeEvent(e);\n            const currentStepButton = document.querySelector(`.step-page-button[data-step-number=\"${step}\"]`);\n\n            if (!currentStepButton) {\n                return;\n            }\n\n            const allStepButtons = document.querySelectorAll(`.step-page-button[data-step-number]`);\n            for (const button of allStepButtons) {\n                blurStepButton(button);\n            }\n            highlightStepButton(currentStepButton);\n        });\n\n        wrapper?.addEventListener(eventList.pageChange, async (e) => {\n\n            if (isDebugMode()) {\n                window.console.log(`${component}: Saving history...`);\n            }\n\n            const step = getPreviousStepByPageChangeEvent(e);\n            if (step < 1) {\n                if (isDebugMode()) {\n                    window.console.log(e);\n                    window.console.log(`${component}: Nothing to be save...`);\n                }\n                return;\n            }\n            const text = getStepInputText(step);\n            const response = await api.recordHistory(this.assignmentId, this.submissionId, text, step);\n\n            if (isDebugMode() && response.hasOwnProperty(\"checksum\")) {\n                if (!response.checksum) {\n                    window.console.log(`${component}: Cannot determine changes in the data`);\n                    return;\n                }\n\n                const textChecksum = await getHashCode(text);\n                if (response.checksum === textChecksum) {\n                    window.console.log(`${component}: Input text got recorded`);\n                }\n                else {\n                    window.console.log(`${component}: Nothing has been changed`);\n                }\n            }\n        });\n\n        document.querySelector(selectors.expandSelection)?.addEventListener(\"click\", async (e) => {\n\n            if (isDebugMode()) {\n                window.console.log(`${component}: Expand selected text...`);\n            }\n            const step = getCurrentStep(e.target);\n            const textData = getStepTextAreaData(step);\n\n            const text = textData.text;\n            const selectedText = textData?.selectedText;\n\n            if (!validateInputText(selectedText)) {\n                if (isDebugMode()) {\n                    window.console.warn(`${component}: No selection detected`);\n                }\n                return;\n            }\n\n            loadingData();\n\n            try {\n                const response = await api.expandText(\n                    this.assignmentId,\n                    this.submissionId,\n                    text,\n                    selectedText,\n                    textData.selectionStart\n                );\n                setApiResponseToInput(this.currentStep, response);\n            }\n            catch (exception) {\n                await Notification.exception(exception);\n            }\n        });\n\n        document.querySelector(selectors.doAIMagic)?.addEventListener(\"click\", async (e) => {\n\n            if (isDebugMode()) {\n                window.console.log(`${component}: Do AI magic...`);\n            }\n\n            const text = getStepInputText(getCurrentStep(e.target));\n\n            if (!validateInputText(text)) {\n                if (isDebugMode()) {\n                    window.console.warn(`${component}: Input text is empty`);\n                }\n                return;\n            }\n\n            loadingData();\n\n            try {\n                const response = await api.generateText(\n                    this.assignmentId,\n                    this.submissionId,\n                    text,\n                    this.currentStep\n                );\n                setApiResponseToInput(this.currentStep, response);\n            }\n            catch (exception) {\n                await Notification.exception(exception);\n            }\n        });\n    };\n\n    const setApiResponseToInput = (step, response) => {\n        $(':button').prop('disabled', false);\n        if (response.hasOwnProperty('attempt_text')) {\n            setRemainingAttemptText(response.attempt_text);\n        }\n        if (response.hasOwnProperty('data')) {\n            const textArea = getStepTextArea(step);\n            if (textArea instanceof HTMLTextAreaElement) {\n                textArea.value = response.data;\n                textArea.dispatchEvent(new Event(\"change\"));\n            }\n        }\n        $('#loader').addClass('d-none');\n    };\n\n    return new EventCreator(assignmentId);\n};\n"],"names":["assignmentId","EventCreator","submissionId","currentStep","selectedStart","selectedEnd","init","component","eventList","selectors","isDebugMode","M","_M","cfg","_M$cfg","developerdebug","getStepTextArea","step","document","querySelector","getCurrentStep","element","Number","parseInt","dataset","_element$dataset","isNaN","getStepInputText","_getStepTextArea","value","validateInputText","text","length","modal","loadingData","prop","removeClass","getCurrentStepByPageChangeEvent","event","detail","_event$detail","requestAIApi","methodName","parameters","Ajax","call","methodname","args","api","selectedText","selectStart","assignment_id","submission","selected_text","select_start","prototype","blurStepButton","button","HTMLElement","classList","remove","add","wrapper","addEventListener","e","window","console","log","currentStepButton","allStepButtons","querySelectorAll","async","prevStep","_event$detail2","getPreviousStepByPageChangeEvent","response","this","hasOwnProperty","checksum","textChecksum","buffer","TextEncoder","encode","raw","crypto","subtle","digest","Array","from","Uint8Array","map","b","toString","padStart","join","getHashCode","textData","textArea","HTMLTextAreaElement","substring","selectionStart","selectionEnd","getStepTextAreaData","target","setApiResponseToInput","exception","Notification","warn","label","innerHTML","setRemainingAttemptText","attempt_text","data","dispatchEvent","Event","addClass"],"mappings":"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"}