define("assignsubmission_pxaiwriter/pxaiendpoint",["exports","jquery","core/ajax","core/notification"],(function(_exports,_jquery,_ajax,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification);_exports.init=function(assignmentId,submissionId){let stepNumber=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const defaultStep=1;let EventCreator=function(assignmentId,submissionId,stepNumber){this.currentStep=stepNumber,this.selectedStart=0,this.selectedEnd=0,this.assignmentId=assignmentId,this.submissionId=submissionId,this.init()};const component="assignsubmission_pxaiwriter",eventList={pageChange:"page-change",stepTextSave:"step-save"},selectors={wrapper:".assignsubmission_pxaiwriter",doAIMagic:"#pxaiwriter-do-ai-magic",expandSelection:"#pxaiwriter-expand-selection",input:".pxaiwriter-student-data[data-input-step]"},getStepInput=step=>{const element=document.querySelector("".concat(selectors.input,'[data-input-step="').concat(step,'"]'));return element instanceof HTMLTextAreaElement?element:null},copyTextFromPreviousStep=step=>{isDebugMode()&&window.console.log("".concat(component,": Try to copy the text from the previous step to step ").concat(step,"..."));const currentStepInput=getStepInput(step);if(null===currentStepInput)return void(isDebugMode()&&window.console.log("".concat(component,": Cannot find the current step ").concat(step)));if(0!==currentStepInput.value.trim().length)return void(isDebugMode()&&window.console.log("".concat(component,": Cannot copy because the current step (").concat(step,") is not empty")));const previousStep=step-1,previousStepInput=getStepInput(previousStep);null!==previousStepInput?0!==previousStepInput.value.trim().length?(currentStepInput.value=previousStepInput.value,isDebugMode()&&window.console.log("".concat(component,": Copied the text from step ").concat(previousStep," to ").concat(step))):isDebugMode()&&window.console.log("".concat(component,": Cannot copy because the previous step (").concat(step,") is empty")):isDebugMode()&&window.console.log("".concat(component,": Cannot find the previous step ").concat(previousStep))},preventPasting=target=>{const elements=document.querySelectorAll(target);if(elements)for(const element of elements)element.addEventListener("keydown",(event=>{if(event.ctrlKey&&"v"===event.key)return event.preventDefault(),event.stopPropagation(),!1})),element.addEventListener("paste",(event=>(event.preventDefault(),event.stopPropagation(),!1)))},isDebugMode=()=>{var _M,_M$cfg;return!(null===(_M=M)||void 0===_M||null===(_M$cfg=_M.cfg)||void 0===_M$cfg||!_M$cfg.developerdebug)},setRemainingAttemptText=text=>{if(!text)return;const label=document.querySelector(".remaining-ai-attempts");label instanceof HTMLElement&&(label.innerHTML=text)},getStepTextArea=step=>document.querySelector('textarea[name="pxaiwriter-data-step-'.concat(step,'"]')),getStepNumber=element=>{var _element$dataset;const currentStep=Number.parseInt(null==element||null===(_element$dataset=element.dataset)||void 0===_element$dataset?void 0:_element$dataset.step);return Number.isNaN(currentStep)?0:currentStep},getStepTextAreaData=step=>{const textArea=getStepTextArea(step);return textArea instanceof HTMLTextAreaElement?{text:textArea.value,selectedText:textArea.value.substring(textArea.selectionStart,textArea.selectionEnd),selectionStart:textArea.selectionStart,selectionEnd:textArea.selectionEnd}:null},getStepInputText=step=>{var _getStepTextArea$valu,_getStepTextArea;return null!==(_getStepTextArea$valu=null===(_getStepTextArea=getStepTextArea(step))||void 0===_getStepTextArea?void 0:_getStepTextArea.value)&&void 0!==_getStepTextArea$valu?_getStepTextArea$valu:""},validateInputText=text=>!(!text||0===text.length)||((0,_jquery.default)("#title-required-warning-modal").modal("show"),!1),loadingData=()=>{(0,_jquery.default)(":button").prop("disabled",!0),(0,_jquery.default)("#loader").removeClass("d-none")},getCurrentStepByPageChangeEvent=event=>{var _event$detail;return null==event||null===(_event$detail=event.detail)||void 0===_event$detail?void 0:_event$detail.currentStep},getPreviousStepByPageChangeEvent=event=>{var _event$detail2;const currentStep=getCurrentStepByPageChangeEvent(event),prevStep=null==event||null===(_event$detail2=event.detail)||void 0===_event$detail2?void 0:_event$detail2.prevStep;return currentStep===prevStep?0:prevStep},getHashCode=async text=>{if(!text)return null;try{const buffer=(new TextEncoder).encode(text),raw=await crypto.subtle.digest("SHA-256",buffer);return Array.from(new Uint8Array(raw)).map((b=>b.toString(16).padStart(2,"0"))).join("")}catch(e){}return null},requestAIApi=function(methodName){let parameters=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return _ajax.default.call([{methodname:methodName,args:parameters}])[0]},api={expandText:function(assignmentId,submissionId,text,selectedText,selectStart){let step=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return requestAIApi("assignsubmission_pxaiwriter_expand_ai_text",{assignment_id:assignmentId,submission:submissionId,text:text,selected_text:selectedText,select_start:selectStart,step:step})},generateText:function(assignmentId,submissionId,text){let step=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return requestAIApi("assignsubmission_pxaiwriter_generate_ai_text",{assignment_id:assignmentId,submission:submissionId,text:text,step:step})},recordHistory:function(assignmentId,submissionId,text){let step=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return requestAIApi("assignsubmission_pxaiwriter_record_history",{assignment_id:assignmentId,submission:submissionId,text:text,step:step})}};EventCreator.prototype.init=function(){var _document$querySelect,_document$querySelect2;preventPasting(selectors.input);const blurStepButton=button=>{button instanceof HTMLElement&&(button.classList.remove("btn-outline-primary"),button.classList.add("btn-outline-secondary"))},wrapper=document.querySelector(selectors.wrapper);null==wrapper||wrapper.addEventListener(eventList.pageChange,(e=>{isDebugMode()&&window.console.log("".concat(component,": Step switched..."));let step=getCurrentStepByPageChangeEvent(e);const currentStepButton=document.querySelector('.step-page-button[data-step-number="'.concat(step,'"]'));if(!currentStepButton)return;const allStepButtons=document.querySelectorAll(".step-page-button[data-step-number]");for(const button of allStepButtons)blurStepButton(button);var button;(button=currentStepButton)instanceof HTMLElement&&(button.classList.add("btn-outline-primary"),button.classList.remove("btn-outline-secondary")),copyTextFromPreviousStep(step)})),null==wrapper||wrapper.addEventListener(eventList.pageChange,(async e=>{isDebugMode()&&window.console.log("".concat(component,": Page changed"));const step=getPreviousStepByPageChangeEvent(e);await recordHistory(step)})),null===(_document$querySelect=document.querySelector(selectors.expandSelection))||void 0===_document$querySelect||_document$querySelect.addEventListener("click",(async e=>{isDebugMode()&&window.console.log("".concat(component,": Expand selected text..."));const step=getStepNumber(e.target),textData=getStepTextAreaData(step),text=textData.text,selectedText=null==textData?void 0:textData.selectedText;if(validateInputText(selectedText)){loadingData();try{const response=await api.expandText(assignmentId,submissionId,text,selectedText,textData.selectionStart);setApiResponseToInput(this.currentStep,response),await dispatchHistoryFromInput()}catch(exception){await _notification.default.exception(exception)}}else isDebugMode()&&window.console.warn("".concat(component,": No selection detected"))})),null===(_document$querySelect2=document.querySelector(selectors.doAIMagic))||void 0===_document$querySelect2||_document$querySelect2.addEventListener("click",(async e=>{isDebugMode()&&window.console.log("".concat(component,": Do AI magic..."));const text=getStepInputText(getStepNumber(e.target));if(validateInputText(text)){loadingData();try{const response=await api.generateText(assignmentId,submissionId,text,defaultStep);setApiResponseToInput(this.currentStep,response),await dispatchHistoryFromInput()}catch(exception){await _notification.default.exception(exception)}}else isDebugMode()&&window.console.warn("".concat(component,": Input text is empty"))}))};const setApiResponseToInput=(step,response)=>{if((0,_jquery.default)(":button").prop("disabled",!1),response.hasOwnProperty("attempt_text")&&setRemainingAttemptText(response.attempt_text),response.hasOwnProperty("data")){const textArea=getStepTextArea(step);textArea instanceof HTMLTextAreaElement&&(textArea.value=response.data,textArea.dispatchEvent(new Event("change")))}(0,_jquery.default)("#loader").addClass("d-none")},recordHistory=async step=>{if(isDebugMode()&&window.console.log("".concat(component,": Saving history...")),step<1)return void(isDebugMode()&&window.console.log("".concat(component,": Nothing to be save...")));const text=getStepInputText(step),response=await api.recordHistory(assignmentId,submissionId,text,step);if(isDebugMode()&&response.hasOwnProperty("checksum")){if(!response.checksum)return void window.console.log("".concat(component,": Cannot determine the changes in the data"));let textChecksum=await getHashCode(text);textChecksum=textChecksum.toLocaleLowerCase(),response.checksum===textChecksum?window.console.log("".concat(component,": Input text got recorded")):window.console.log("".concat(component,": Nothing has been changed"))}},dispatchHistoryFromInput=async()=>{const elements=document.querySelectorAll(selectors.input);for(const element of elements)element instanceof HTMLTextAreaElement&&await recordHistory(getStepNumber(element))};return new EventCreator(assignmentId,submissionId,stepNumber)}}));

//# sourceMappingURL=pxaiendpoint.min.js.map