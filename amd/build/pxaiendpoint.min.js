define("assignsubmission_pxaiwriter/pxaiendpoint",["exports","jquery","core/ajax","core/notification"],(function(_exports,_jquery,_ajax,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification);_exports.init=assignmentId=>{let EventCreator=function(assignmentId,submissionId){this.currentStep=1,this.selectedStart=0,this.selectedEnd=0,this.assignmentId=assignmentId,this.submissionId=submissionId,this.init()};const component="assignsubmission_pxaiwriter",eventList_pageChange="page-change",selectors_wrapper=".assignsubmission_pxaiwriter",selectors_doAIMagic="#pxaiwriter-do-ai-magic",selectors_expandSelection="#pxaiwriter-expand-selection",isDebugMode=()=>{var _M,_M$cfg;return!(null===(_M=M)||void 0===_M||null===(_M$cfg=_M.cfg)||void 0===_M$cfg||!_M$cfg.developerdebug)},getStepTextArea=step=>document.querySelector('textarea[name="pxaiwriter-data-step-'.concat(step,'"]')),getCurrentStep=element=>{var _element$dataset;const currentStep=Number.parseInt(null==element||null===(_element$dataset=element.dataset)||void 0===_element$dataset?void 0:_element$dataset.step);return Number.isNaN(currentStep)?0:currentStep},getStepInputText=step=>{var _getStepTextArea$valu,_getStepTextArea;return null!==(_getStepTextArea$valu=null===(_getStepTextArea=getStepTextArea(step))||void 0===_getStepTextArea?void 0:_getStepTextArea.value)&&void 0!==_getStepTextArea$valu?_getStepTextArea$valu:""},validateInputText=text=>!(!text||0===text.length)||((0,_jquery.default)("#title-required-warning-modal").modal("show"),!1),loadingData=()=>{(0,_jquery.default)(":button").prop("disabled",!0),(0,_jquery.default)("#loader").removeClass("d-none")},getCurrentStepByPageChangeEvent=event=>{var _event$detail;return null==event||null===(_event$detail=event.detail)||void 0===_event$detail?void 0:_event$detail.currentStep},requestAIApi=function(methodName){let parameters=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return _ajax.default.call([{methodname:methodName,args:parameters}])[0]},api_expandText=(assignmentId,submissionId,text,selectedText,selectStart)=>requestAIApi("assignsubmission_pxaiwriter_expand_ai_text",{assignment_id:assignmentId,submission:submissionId,text:text,selected_text:selectedText,select_start:selectStart,step:1}),api_generateText=(assignmentId,submissionId,text)=>requestAIApi("assignsubmission_pxaiwriter_generate_ai_text",{assignment_id:assignmentId,submission:submissionId,text:text,step:1}),api_recordHistory=function(assignmentId,submissionId,text){let step=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return requestAIApi("assignsubmission_pxaiwriter_record_history",{assignment_id:assignmentId,submission:submissionId,text:text,step:step})};EventCreator.prototype.init=function(){var _document$querySelect,_document$querySelect2;const blurStepButton=button=>{button instanceof HTMLElement&&(button.classList.remove("btn-outline-primary"),button.classList.add("btn-outline-secondary"))},wrapper=document.querySelector(selectors_wrapper);null==wrapper||wrapper.addEventListener(eventList_pageChange,(e=>{isDebugMode()&&window.console.log("".concat(component,": Step switched..."));let step=getCurrentStepByPageChangeEvent(e);const currentStepButton=document.querySelector('.step-page-button[data-step-number="'.concat(step,'"]'));if(!currentStepButton)return;const allStepButtons=document.querySelectorAll(".step-page-button[data-step-number]");for(const button of allStepButtons)blurStepButton(button);var button;(button=currentStepButton)instanceof HTMLElement&&(button.classList.add("btn-outline-primary"),button.classList.remove("btn-outline-secondary"))})),null==wrapper||wrapper.addEventListener(eventList_pageChange,(async e=>{isDebugMode()&&window.console.log("".concat(component,": Saving history..."));const step=(event=>{var _event$detail2;const currentStep=getCurrentStepByPageChangeEvent(event),prevStep=null==event||null===(_event$detail2=event.detail)||void 0===_event$detail2?void 0:_event$detail2.prevStep;return currentStep===prevStep?0:prevStep})(e);if(step<1)return void(isDebugMode()&&(window.console.log(e),window.console.log("".concat(component,": Nothing to be save..."))));const text=getStepInputText(step),response=await api_recordHistory(this.assignmentId,this.submissionId,text,step);if(isDebugMode()&&response.hasOwnProperty("checksum")){if(!response.checksum)return void window.console.log("".concat(component,": Cannot determine changes in the data"));const textChecksum=await(async text=>{if(!text)return null;try{const buffer=(new TextEncoder).encode(text),raw=await crypto.subtle.digest("SHA-256",buffer);return Array.from(new Uint8Array(raw)).map((b=>b.toString(16).padStart(2,"0"))).join("")}catch(e){}return null})(text);response.checksum===textChecksum?window.console.log("".concat(component,": Input text got recorded")):window.console.log("".concat(component,": Nothing has been changed"))}})),null===(_document$querySelect=document.querySelector(selectors_expandSelection))||void 0===_document$querySelect||_document$querySelect.addEventListener("click",(async e=>{isDebugMode()&&window.console.log("".concat(component,": Expand selected text..."));const textData=(step=>{const textArea=getStepTextArea(step);return textArea instanceof HTMLTextAreaElement?{text:textArea.value,selectedText:textArea.value.substring(textArea.selectionStart,textArea.selectionEnd),selectionStart:textArea.selectionStart,selectionEnd:textArea.selectionEnd}:null})(getCurrentStep(e.target)),text=textData.text,selectedText=null==textData?void 0:textData.selectedText;if(validateInputText(selectedText)){loadingData();try{const response=await api_expandText(this.assignmentId,this.submissionId,text,selectedText,textData.selectionStart);setApiResponseToInput(this.currentStep,response)}catch(exception){await _notification.default.exception(exception)}}else isDebugMode()&&window.console.warn("".concat(component,": No selection detected"))})),null===(_document$querySelect2=document.querySelector(selectors_doAIMagic))||void 0===_document$querySelect2||_document$querySelect2.addEventListener("click",(async e=>{isDebugMode()&&window.console.log("".concat(component,": Do AI magic..."));const text=getStepInputText(getCurrentStep(e.target));if(validateInputText(text)){loadingData();try{const response=await api_generateText(this.assignmentId,this.submissionId,text,this.currentStep);setApiResponseToInput(this.currentStep,response)}catch(exception){await _notification.default.exception(exception)}}else isDebugMode()&&window.console.warn("".concat(component,": Input text is empty"))}))};const setApiResponseToInput=(step,response)=>{if((0,_jquery.default)(":button").prop("disabled",!1),response.hasOwnProperty("attempt_text")&&(text=>{if(!text)return;const label=document.querySelector(".remaining-ai-attempts");label instanceof HTMLElement&&(label.innerHTML=text)})(response.attempt_text),response.hasOwnProperty("data")){const textArea=getStepTextArea(step);textArea instanceof HTMLTextAreaElement&&(textArea.value=response.data,textArea.dispatchEvent(new Event("change")))}(0,_jquery.default)("#loader").addClass("d-none")};return new EventCreator(assignmentId)}}));

//# sourceMappingURL=pxaiendpoint.min.js.map